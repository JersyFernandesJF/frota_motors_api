name: Frota Motors Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
      # AWS S3 Configuration
      SPRING_S3_ACCESS_KEY: ${{ secrets.SPRING_S3_ACCESS_KEY }}
      SPRING_S3_SECRET_KEY: ${{ secrets.SPRING_S3_SECRET_KEY }}
      SPRING_S3_REGION: ${{ secrets.SPRING_S3_REGION }}
      SPRING_S3_BUCKET_NAME: ${{ secrets.SPRING_S3_BUCKET_NAME }}
      SPRING_S3_ENDPOINT: ${{ secrets.SPRING_S3_ENDPOINT }}
      # JWT Configuration
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configuring JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build com Maven
      run: |
        mvn clean package -DskipTests
    
    - name: Prepare artifacts
      run: |
        mkdir -p frota-motors-deploy-artifacts
        cp ./target/frota-motors-api-0.0.1-SNAPSHOT.jar frota-motors-deploy-artifacts/
     
    - name: Criar diretório no servidor
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_AWS_SERVER_HOST }}
        username: ${{ secrets.SSH_AWS_SERVER_USER_NAME }}
        key: ${{ secrets.SSH_AWS_SERVER_PRIVATE_KEY }}
        script: |
          mkdir -p /home/ubuntu/frota-motors-deploy-artifacts

    - name: Direct upload to frota-motors-artifacts
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_AWS_SERVER_HOST }}
        username: ${{ secrets.SSH_AWS_SERVER_USER_NAME }}
        key: ${{ secrets.SSH_AWS_SERVER_PRIVATE_KEY }}
        source: "frota-motors-deploy-artifacts/frota-motors-api-0.0.1-SNAPSHOT.jar"
        target: "/home/ubuntu/"

    - name: Parar instância antiga e iniciar nova
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_AWS_SERVER_HOST }}
        username: ${{ secrets.SSH_AWS_SERVER_USER_NAME }}
        key: ${{ secrets.SSH_AWS_SERVER_PRIVATE_KEY }}
        envs: |
          SPRING_S3_ACCESS_KEY=${{ secrets.SPRING_S3_ACCESS_KEY }}
          SPRING_S3_SECRET_KEY=${{ secrets.SPRING_S3_SECRET_KEY }}
          SPRING_S3_REGION=${{ secrets.SPRING_S3_REGION }}
          SPRING_S3_BUCKET_NAME=${{ secrets.SPRING_S3_BUCKET_NAME }}
          SPRING_S3_ENDPOINT=${{ secrets.SPRING_S3_ENDPOINT }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
        script: |
          echo "Verificando se já existe uma instância rodando..."
          PID=$(ps aux | grep frota-motors-api | grep -v grep | awk '{print $2}')
          if [ ! -z "$PID" ]; then
            echo "Parando frota-motors-api (PID: $PID)"
            kill -9 $PID
          else
            echo "Nenhuma instância em execução encontrada."
          fi
          
          echo "Limpando regras de iptables conflitantes (nginx faz o roteamento)..."
          sudo iptables -t nat -A PREROUTING -p tcp --dport 90 -j REDIRECT --to-port 9090
          
          chmod +x /home/ubuntu/frota-motors-deploy-artifacts/frota-motors-api-0.0.1-SNAPSHOT.jar
          
          echo "Iniciando aplicação com variáveis de ambiente..."
          nohup java \
            -DSPRING_S3_ACCESS_KEY="$SPRING_S3_ACCESS_KEY" \
            -DSPRING_S3_SECRET_KEY="$SPRING_S3_SECRET_KEY" \
            -DSPRING_S3_REGION="$SPRING_S3_REGION" \
            -DSPRING_S3_BUCKET_NAME="$SPRING_S3_BUCKET_NAME" \
            -DSPRING_S3_ENDPOINT="$SPRING_S3_ENDPOINT" \
            -DJWT_SECRET="$JWT_SECRET" \
            -jar /home/ubuntu/frota-motors-deploy-artifacts/frota-motors-api-0.0.1-SNAPSHOT.jar > /home/ubuntu/frota-motors-deploy-artifacts/frota-motors-api.log 2>&1 &
          echo "Aplicação iniciada em background!"
